<div class="main-wrapper">
  <div class="container">
    <div class="mx-auto col-lg-10">
      <h2 class="mt-3 main-title">History Prediction</h2>
      <div class="d-flex mb-3">
        <a href="/uploadData" class="btn btn-outline-info me-auto">
          Initialize Dataset
        </a>
        <a href="/initializeModel" class="btn btn-outline-warning">
          Initialize Model
        </a>
        <a href="/updateModel" class="ms-2 btn btn-outline-success">
          Update Model
        </a>
      </div>
      <% if (success_msg) { %>
        <p class="success-alert">
          <%= success_msg %>
        </p>	
      <% } %>
      <% if (error_msg) { %>
        <p class="fail-alert">
          <%= error_msg %>
        </p>
      <% } %>
      <div class="users-table table-wrapper">
      <% if (combinedData.length > 0) { %>
        <table class="posts-table">
          <thead>
            <tr class="users-table-info">
              <th scope="col">#</th>
              <th scope="col">Timestamp</th>
              <th scope="col">Predicted CO</th>
              <th scope="col">Predicted PM2.5</th>
              <th scope="col">Actual CO</th>
              <th scope="col">Actual PM2.5</th>
              <th scope="col">Delete</th>
            </tr>
          </thead>
          <tbody>
            <% combinedData.forEach((data, idx) => { %>
            <tr>
              <td><%= (currentPage - 1) * 15 + idx + 1 %></td>
              <td><%= new Date(data.timestamp).toLocaleString() %></td>
              <td><%= data.predictedCO !== null ? data.predictedCO.toFixed(2) : 'N/A' %></td>
              <td><%= data.predictedPM25 !== null ? data.predictedPM25.toFixed(2) : 'N/A' %></td>
              <td><%= data.actualCO !== null ? data.actualCO.toFixed(2) : 'N/A' %></td>
              <td><%= data.actualPM25 !== null ? data.actualPM25.toFixed(2) : 'N/A' %></td>
              <td><button class="rounded-4 btn btn-danger btn-sm dlt-btn" data-id="<%= data._id %>">
                <span><i class="bi bi-trash3-fill"></i></span> Delete
              </button></td>
            </tr>
          <% }) %>
          </tbody>
        </table>
      <% } else { %>
      </div>
        <p>No prediction results available.</p>
      <% } %>
    </div>
  </div>
  <nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
      <% if (currentPage > 1) { %>
        <li class="page-item">
          <a class="page-link" href="?page=<%= currentPage - 1 %>">Previous</a>
        </li>
      <% } %>
      <% for (let i = 1; i <= totalPages; i++) { %>
        <li class="page-item <%= currentPage === i ? 'active' : '' %>">
          <a class="page-link" href="?page=<%= i %>"><%= i %></a>
        </li>
      <% } %>
      <% if (currentPage < totalPages) { %>
        <li class="page-item">
          <a class="page-link" href="?page=<%= currentPage + 1 %>">Next</a>
        </li>
      <% } %>
    </ul>
  </nav>

</div>

<footer class="bg-light text-center text-white">
  <!-- Grid container -->
  <div class="container p-4 pb-0">
    
  </div>
  <!-- Grid container -->

  <!-- Copyright -->
  <div class="text-center p-3" style="background-color: rgba(0, 0, 0, 0.2);">
    Â© 2024 Copyright: AIRMIND, Inc
  </div>
  <!-- Copyright -->
</footer>

<script src="plugins/feather.min.js"></script>
<script src="/js/script.js"></script>
<script>
  document.querySelectorAll('.dlt-btn').forEach(button => {
      button.addEventListener('click', async function(event) {
        event.preventDefault();
        const predictionId = this.getAttribute('data-id');

        try{
          const response = await fetch('/deletePrediction', {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ predictionId }) 
          });
          // Debug: Log the raw response before parsing as JSON
          const text = await response.text();
          console.log('Raw response:', text);

          const result = JSON.parse(text);
            if (response.ok) {
              alert('Delete prediction successfully');
              location.reload();
            } else {
              alert(result.error);
            }

        }catch(error){
          console.error('Error during delete prediction:', error);
          alert('An error occurred during delete prediction');
        }
      })
    });

</script>
